---
title: 'Relation between GPP and T at different depth'
author: "Benoît D'ANGELO"
date: "23/02/2015"
output:
  html_document:
    theme: flatly
    toc: yes
---

***
<a href="../TOC_VS.html"> Retour 1re page </a>

***

# Introduction

The aim of this document is to explore the relationship between GPP (Gross Primary Production) and the temperatures measured at differents depth.
For each plot and each temperature, models (linear, exponential and arrhenius), have been calculated.

```{r load_env, eval=TRUE, echo=FALSE, message=FALSE}
rm(list=ls(all=TRUE))
# library(laguettevarspa)
library(ggplot2)
library(dplyr)
library(tidyr)
library(knitr)

# Path to the project
proj_pth <- "/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG"
# Path to graph output
output_pth <- "/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/graphs/relation_flux_T"

# Allow plot a larger document
options(width = 400)
set_alias(w = "fig.width", h = "fig.height") 
# opts_chunk$set(fig.align="center")
```

```{r load_fn, eval=TRUE, echo=FALSE, message=FALSE}
# histogramm + normal distribution plot
distr <- function(y, xlab){
  par(mar=c(5.1,5.1,2.1,2.1))
  hist(y,
     freq=FALSE,
     cex.lab=1.5, cex.axis=1.4, cex.main=1.5, cex.sub=1.5,
#      breaks=4,
     xlab=xlab, ylab="densité", main="")
curve(dnorm(x, mean=mean(y), sd=sd(y)), add=TRUE, col="darkblue", lwd=2) 
}

# df format: placette ; Re ; temperature ; WT ; ID_camp
plt_mdl_p7 <- function(df, Tsel, xlab="photosynthèse brute", f_name="out.pdf" , param=mlabel){
#   set up data frames
  df <- filter(df, T_type == Tsel)
  param <- filter(param, T_type == Tsel)
#   regselect use indicator
  df$ctrl <- ifelse(df$date > as.Date("2014-04-14"), 
                    "no", "yes")
#   text annotation positionning
  txt_x <- 5
  txt_y <- floor(max(df$flux, na.rm=T))+1
#   plot
  plt <- ggplot(df, aes(x=T_value, y=flux, colour = ctrl))+
    geom_point(size=4, shape=21) +
    scale_colour_manual(values=c("red", "black"))+
    labs(y=expression(paste("photosynthèse brute (", mu, mol,m^-2,s^-1,")", sep="")), x=xlab)+
    #   geom_line(data=result, aes(x=T_value, y=mdl1), color = "red")+
    #   geom_line(data=result, aes(x=T_value, y=mdl2), color = "blue")+
    #   geom_line(data=result, aes(x=T_value, y=mdl3), color = "orange")+
    facet_wrap(~placette)+
    ylim(0,max(df$flux, na.rm=TRUE))+
    xlim(5,max(df$T_value, na.rm=TRUE))+
    theme_bw(base_size = 18)+ 
    #   theme(legend.position = "none")+
    geom_text(data=filter(param, equation == "linear"), aes(label=paste("R^2==", R2, "(lin)~~~slope==", slope, sep="")), x=txt_x, y=(txt_y-2), hjust=0, size=4, parse=T, color = "red")+
    geom_text(data=filter(param, equation == "exponential"), aes(label=paste("R^2==", R2, "(exp)", sep="")), x=txt_x, y=(txt_y-4), hjust=0, size=4, parse=T, color = "blue")+
    geom_text(data=filter(param, equation == "arrhenius"), aes(label=paste("R^2==", R2, "(arr)", sep="")), x=txt_x, y=(txt_y-6), hjust=0, size=4, parse=T, color = "orange")
  print(plt)
#   plt_name <- sprintf("/[pts][all][%s_%s].pdf",plt$labels$x, plt$labels$y)
  ggsave(file.path(output_pth,f_name), width=12, height=8)
  }
```

```{r load_data, eval=TRUE, echo=FALSE, message=FALSE}
T_levels <- c("Tair", "Tsurf", "T5", "T10", "T15", "T20", "T25", "T30", "T40", "T50", "T60", "T70", "T80", "T90", "T100")
# Flux data
flux_p7 <- file.path(proj_pth, "data", "processed", "flux_p7.csv")
df <- read.csv(flux_p7)%>%
  filter(F_type == "GPP")%>%
  mutate(date = as.Date(date),
         T_type = factor(T_type, levels = T_levels))
# Models data
mdl_p7 <- file.path(proj_pth, "data", "processed", "mdl_p7.csv")
mdl <- read.csv(mdl_p7)%>%
  filter(F_type == "GPP")%>%
  mutate(T_type = factor(T_type, levels = T_levels))

# Create labels for plots 
mlabel <- mdl %>%
  select(placette, T_type, equation, intercept, slope, 
         R2, R2a, R, se, AIC)
mlabel[,4:10] <- lapply(mlabel[,4:10], round, 2)
```

# Overview

## flux

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=6}
ggplot(df, aes(x=date, y=flux))+
  geom_point(size=4, shape=21)+
  labs(y="GPP", x="date")+
  theme_bw()

summary(df$flux)
```

## Models
```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=12, fig.height=5}
ggplot(mdl, aes(x=T_type, y=R2))+
  geom_point(size=4, aes(color=equation)) +
  labs(title=("Évolution du R² des modèles linéaire (rouge) et exponentiel (bleu) \n liant la photosynthèse brute de l'écosystème (Re) à la température (à différentes profondeur)"))+
#   annotate("segment", x=c(5,6), xend=(5,6), y=(0.4,0.4), yend=(0.6,0.6), color = "blue", size = 2, arrow=arrow())+
  facet_wrap(~equation)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1.1, vjust=1.1, size=12))

# plt_name <- sprintf("/[pts][all][%s_%s].png",plt$labels$x, plt$labels$y)
# ggsave(paste(output_pth,plt_name,sep=""), width=12, height=8)
```

As there are a tons of regressions, first let's see an overview of the models behaviour : 

### Mean R^2^ of the models depending on temperature measurement depth and used equation
```{r, echo=FALSE}
tableR2 <- mdl %>%
  group_by(T_type, equation)%>%
  summarise(R2=round(mean(R2, na.rm=T),2))%>%
  spread(equation, R2)

tableR2
```

the maximum R^2^ are `r max(tableR2$linear)`, `r max(tableR2$exponential)` and `r max(tableR2$arrhenius)`, for the linear, exponential and arrhenius equation respectively.
For all equation the higher R^2^ mean is found for temperature measurde around 15 -- 20 cm depth.

### Models evolution with temperature measurement depth

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=15, fig.height=8}
ggplot(mdl, aes(x=T_type, y=R2))+
  geom_line(aes(color=equation, group=equation)) +
#   labs(title=("Évolution du R² des modèles linéaire (rouge) et exponentiel (bleu) \n liant la photosynthèse brute de l'écosystème (Re) à la température (à différentes profondeur)"))+
  labs(y="R²", x="Profondeur de la température")+
  facet_wrap(~placette)+
  theme_bw(base_size = 20)+
  theme(axis.text.x = element_text(angle=45, hjust=1.1, vjust=1.1, size=12))
ggsave(file.path(output_pth,"GPP_R2_depth.pdf"), width=12, height=8)
```
The exponential equation seems to be at least as good as the linear one.
The arrhenius equation is usually close to the exponential one but lead to lower R^2^ with some exceptions depending on the measurement depth:

* plot #4 between T5 and T25
* plot #11 between Tsurf T50...


# Details of the models

## Air temperature
```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=14, fig.height=8}
plt_mdl_p7(df, Tsel = "Tair", xlab="Air temperature (°C)", f_name="GPP_Tair_p7.pdf")
```

### Linear equation
```{r , eval=TRUE, multipleplots, echo=FALSE, message=FALSE, warning=FALSE, fig.width=4.5 ,fig.height=4}
slplin <- mdl %>%
  filter(T_type == "Tair", equation == "linear")%>%
  select(slope, R2)

distr(slplin$slope, "pente modèle linéaire")
distr(slplin$R2, "R2 modèle linéaire")
```

### Exponential equation
```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=4.5 ,fig.height=4}
slplin <- mdl %>%
  filter(T_type == "Tair", equation == "exponential")%>%
  select(R2, Q10)

distr(slplin$Q10, "Q10 modèle exponentiel")
distr(slplin$R2, "R2 modèle exponentiel")
```

## Peat temperature at 15 cm depth
```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=14, fig.height=8}
plt_mdl_p7(df, Tsel = "T15", xlab="15 cm depth temperature (°C)", f_name="GPP_T15_p7.pdf")
```

### Linear equation
```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=4.5 ,fig.height=4}
slplin <- mdl %>%
  filter(T_type == "T15", equation == "linear")%>%
  select(slope, R2)

distr(slplin$slope, "pente modèle linéaire")
distr(slplin$R2, "R2 modèle linéaire")
```

### Exponential equation
```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, fig.width=4.5 ,fig.height=4}
slplin <- mdl %>%
  filter(T_type == "T15", equation == "exponential")%>%
  select(R2, Q10)

distr(slplin$Q10, "Q10 modèle exponentiel")
distr(slplin$R2, "R2 modèle exponentiel")
```



```{r , eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
gQ10 <- round(exp(10*summary(lm(log(df$flux)~df$T15))$coef[2]), 2)
gQ10
```

```{r , eval=FALSE, echo=FALSE, message=FALSE, warning=FALSE}
gQ10 <- round(exp(10*summary(lm(log(df$flux)~df$T_Chb_N.mean))$coef[2]), 2)
gQ10
```







# TRASH

## Évolution de la moyenne de la photosynthèse brute en fonction du nombre de placette : 
```{r , eval=F, echo=FALSE, message=FALSE, warning=FALSE, w=10, h=6, dpi=100, cache=TRUE}
tirage <- 100
dat <- data.frame()
for (i in 2:20){# une série de tirage de 2 à 20 placette
  mn <- data.frame()
  for(h in 1:tirage){ # nb de tirage par taille
    sel <- as.vector(sample(unique(df$placette), i))
    w <- data.frame()
    for (j in sel){ # pour chaque item sélectionné on prend le sub7 qui correspond
      w <- rbind(w, df[which(df$placette == j),])
      }
    mn <- rbind(mn, mean(w$flux, na.rm=T))
# round(exp(10*summary(lm(log(Re)~temperature))$coef[2]), 2),
#     mn <- rbind(mn, exp(10*summary(lm(log(w$Re)~w$Tair))$coef[2]))
    }
  if(i == 2){
    dat <- mn
    }else{
      dat <- cbind(dat,mn)
      }
  }
colnames(dat) <- 2:20

resul <- ddply(melt(dat), .(variable), summarise, mean=mean(value, na.rm=T),
               sd=sd(value, na.rm=T))

resul$se <- resul$sd/sqrt(tirage*as.numeric(as.character(resul$variable)))
resul$ci95 <- 95/2*resul$se

ggplot(resul, aes(x=variable, y=mean, group=1))+
#   geom_ribbon(aes(ymin=mean-se, ymax=mean+se), alpha = .2)+
  geom_line(aes(y=mean-se), colour="grey50", linetype = "dotted")+
  geom_line(aes(y=mean+se), colour="grey50", linetype = "dotted")+
#   labs(x="nombre de placette", y="moyenne Q10")+
  labs(x="nombre de placette", y="photosynthèse brute moyenne (µmol.m.⁻²s⁻¹) ")+
  geom_line()+
  theme_bw(base_size = 28)

ggplot(resul, aes(x=variable, y=mean, group=1))+
#   geom_ribbon(aes(ymin=mean-se, ymax=mean+se), alpha = .2)+
  geom_line(aes(y=mean-ci95), colour="grey50", linetype = "dotted")+
  geom_line(aes(y=mean+ci95), colour="grey50", linetype = "dotted")+
  geom_line()+
#   labs(x="nombre de placette", y="moyenne Q10")+
  labs(x="nombre de placette", y="photosynthèse brute moyenne  (µmol.m.⁻²s⁻¹) ")+
#   ylim(3,4)+
  theme_bw(base_size = 28)
```


```{r TRASH, eval=FALSE}
# TRASH: CODE NOT USED
# Permet de tracer les courbes des modèles
# Etait appelée par plt_mdl_p7
mdls <- function(df){
  mdl1 <- lm(flux ~ temperature, data = df)
  mdl2 <- lm(log(flux) ~ temperature, data = df)
  mdl3 <- lm(flux ~ temperature + WT, data = df)
  
  prd <- data.frame(temperature = seq(5, 40, by = 0.5), WT = seq(5, 40, by = 0.5))
  result <- prd
  result$mdl1 <- predict(mdl1, newdata = prd)
#   result$mdl2 <- predict(mdl2, newdata = prd)
  result$mdl2 <- exp((coef(mdl2)[2]*result$temperature) + coef(mdl2)[1])
  result$mdl3 <- predict(mdl3, newdata = prd)
  return(result)
  }

```
