Relation Re T
========================================================

### <a href="../TOC_VS.html"> Retour 1re page </a>

***

```{r loadenv, eval=TRUE, echo=FALSE, message=FALSE}

loadenv <- function(){
   source("/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/src/load.R")
#   source("/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_JourNuit/src/3_functions/reportFn.R")
  set_alias(w = "fig.width", h = "fig.height") 
#   cat("loadenv : done \n")
  }

# Calls
loadenv()
dfCO2 <- ld_CO2()
dfPT<- ld_PT(long=F)
dfTE<- ld_TE()
dfHR <- ld_HR()
dfVGrec <- ld_VG_REC(long=FALSE)
dfVGcpt <- ld_VG_CPT()

df <- join(join(dfCO2, dfPT), dfTE)
df <- join(df, dfVGrec)
df <- join(df, dfHR)
df$ID_camp <- as.factor(df$ID_camp)
# df$GPP <- abs(df$Re)

```


```{r function, eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, w=12, h=8, dpi=100}
distr <- function(y, xlab){
  hist(y,
     freq=FALSE,
#      breaks=4,
     xlab=xlab, ylab="densité", main="")
curve(dnorm(x, mean=mean(y), sd=sd(y)), add=TRUE, col="darkblue", lwd=2) 
}
# Est appelée par plt_mdl_p7
mdls <- function(df){
  mdl1 <- lm(GPP ~ Tmprt, data = df)
  mdl2 <- lm(log(GPP) ~ Tmprt, data = df)
  mdl3 <- lm(GPP ~ Tmprt + WT, data = df)
  
  prd <- data.frame(Tmprt = seq(5, 40, by = 0.5), WT = seq(5, 40, by = 0.5))
  result <- prd
  result$mdl1 <- predict(mdl1, newdata = prd)
#   result$mdl2 <- predict(mdl2, newdata = prd)
  result$mdl2 <- exp((coef(mdl2)[2]*result$Tmprt) + coef(mdl2)[1])
  result$mdl3 <- predict(mdl3, newdata = prd)
  return(result)
  }

getcors <- function(df){
  cors <- ddply(df[which(!is.na(df$Tmprt) & !is.na(df$GPP)),], .(placette), summarise, 
              cor = round(cor(Tmprt, GPP), 2), 
              mdl1_sqR = round(summary(lm(GPP~Tmprt))$r.squared, 2),
              mdl1_slp = round(summary(lm(GPP~Tmprt))$coef[2], 2),
              mdl2_sqR = round(summary(lm(log(GPP)~Tmprt))$r.squared, 2),
              mdl2_slp = round(summary(lm(log(GPP)~Tmprt))$coef[2], 2),
              mdl2_Q10 = round(exp(10*summary(lm(log(GPP)~Tmprt))$coef[2]), 2),
              mdl3_sqR = round(summary(lm(GPP~Tmprt+WT))$r.squared, 2),
              mdl3_slp = round(summary(lm(GPP~Tmprt+WT))$coef[2], 2))
  return(cors)
}


# Df de la forme placette ; GPP ; Tmprt ; WT ; ID_camp
plt_mdl_p7 <- function(df, xlab="Respiration"){
  
output_pth <- "/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/graphs"

result <- ddply(df,.(placette),mdls)

# result <-  melt(result, id.vars = c("placette","Tmprt"), variable.name = "model",
#                 value.name = "fitted")
cors <- getcors(df)

txt_x <- 6
txt_y <- floor(max(df$GPP, na.rm=T))

plt <- ggplot(df[which(!is.na(df$Tmprt) & !is.na(df$GPP)),], aes(x=Tmprt, y=GPP))+
#   geom_smooth(method = "lm", se=F, color="red") +
  geom_point(size=4, aes(color=ID_camp)) +
  labs(title="Évolution de la respiration de l'écosystème en fonction de la température de la tourbe", 
              y="Respiration (µmol.m.⁻²s⁻¹)", 
              x=xlab)+
  geom_line(data=result, aes(x=Tmprt, y=mdl1), color = "red")+
  geom_line(data=result, aes(x=Tmprt, y=mdl2), color = "blue")+
  geom_line(data=result, aes(x=Tmprt, y=mdl3), color = "orange")+
  facet_wrap(~placette)+
  ylim(0,max(df$GPP, na.rm=TRUE))+
  xlim(5,max(df$Tmprt, na.rm=TRUE))+
  theme_bw()+ 
  geom_text(data=cors, aes(label=paste("R==", cor, sep="")), x=txt_x, y=txt_y, hjust=0, size=2.5, parse=T)+
  geom_text(data=cors, aes(label=paste("R^2==", mdl1_sqR, "~~~pente==", mdl1_slp, sep="")), x=txt_x, y=(txt_y-2), hjust=0, size=2.5, parse=T, color = "red")+
  geom_text(data=cors, aes(label=paste("R^2==", mdl2_sqR, sep="")), x=txt_x, y=(txt_y-4), hjust=0, size=2.5, parse=T, color = "blue")+
  geom_text(data=cors, aes(label=paste("R^2==", mdl3_sqR, sep="")), x=txt_x, y=(txt_y-6), hjust=0, size=2.5, parse=T, color = "orange")
print(plt)
plt_name <- sprintf("/[pts][all][%s_%s].png",plt$labels$x, plt$labels$y)
ggsave(paste(output_pth,plt_name,sep=""), width=12, height=8)
}
```


## Relation respiration (Re) et température (à différentes profondeur)

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, w=12, h=8, dpi=100}
# Df de la forme placette ; GPP ; Tmprt ; WT ; ID_camp
dfTair <- df[,c("placette","GPP","Tair","WT","ID_camp")]
colnames(dfTair)[3] <- "Tmprt"
plt_mdl_p7(dfTair, xlab="Température de l'air (°C)")

```

Résumé pente modèle linéaire Tair

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
cors <- getcors(dfTair)
summary(cors$mdl1_slp)
distr(cors$mdl1_slp, "pente modèle linéaire")
```

Résumé pente modèle exponentiel Tair

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
summary(cors$mdl2_slp)
distr(cors$mdl2_slp, "pente modèle exponentiel")

summary(cors$mdl2_Q10)
distr(cors$mdl2_Q10, "Q10")
```



```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, w=12, h=8, dpi=100}
dfT5 <- df[,c("placette","GPP","T5","WT","ID_camp")]
colnames(dfT5)[3] <- "Tmprt"
plt_mdl_p7(dfT5, xlab="Température sol à 5 cm (°C)")
```

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, w=12, h=8, dpi=100}
dfT15 <- df[,c("placette","GPP","T15","WT","ID_camp")]
colnames(dfT15)[3] <- "Tmprt"
plt_mdl_p7(dfT15, xlab="Température sol à 15 cm (°C)")

```


Résumé pente modèle linéaire T15

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
cors <- getcors(dfT15)
summary(cors$mdl1_slp)
distr(cors$mdl1_slp, "pente modèle linéaire")
```


Résumé pente modèle exponentiel T15

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
summary(cors$mdl2_slp)
distr(cors$mdl2_slp, "pente modèle exponentiel")

summary(cors$mdl2_Q10)
distr(cors$mdl2_Q10, "Q10")
```

Résumé de l'ensemble des données de respiration
```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
summary(df$GPP)
```


```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
gQ10 <- round(exp(10*summary(lm(log(df$GPP)~df$T15))$coef[2]), 2)
```

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE}
gQ10 <- round(exp(10*summary(lm(log(df$GPP)~df$T_Chb_N.mean))$coef[2]), 2)
```



```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, w=16, h=12, dpi=100}
dfR2 <- join(dfCO2[,c("placette","date","ID_camp", "Re", "T_Chb_N.mean")], dfPT)

colnames(dfR2)[5] <- "Tchb"

dfR2 <-  melt(dfR2, id.vars = c("placette","date","ID_camp", "Re"), variable.name = "Tlevel", value.name = "T")

dfR2$GPP <- abs(dfR2$Re)

dfR2 <- na.omit(dfR2)

dR2 <- ddply(dfR2, .(placette, Tlevel), summarise, 
              mdl1_sqR = round(summary(lm(GPP~T))$r.squared, 2),
#               mdl1_slp = round(summary(lm(GPP~T))$coef[2], 2),
              mdl2_sqR = round(summary(lm(log(GPP)~T))$r.squared, 2))#,
#               mdl2_slp = round(summary(lm(log(GPP)~T))$coef[2], 2))

mdR2 <-  melt(dR2, id.vars = c("placette","Tlevel"), variable.name = "model", value.name = "value")

ggplot(mdR2[which(mdR2$Tlevel != "T100" & mdR2$Tlevel != "T90" & mdR2$Tlevel != "T80" &mdR2$Tlevel != "T70" & mdR2$Tlevel != "T60"),], aes(x=Tlevel, y=value))+
  geom_line(aes(color=model, group=model)) +
  labs(title=("Évolution du R² des modèles linéaire (rouge) et exponentiel (bleu) \n liant la respiration de l'écosystème (Re) à la température (à différentes profondeur)"))+
  facet_wrap(~placette)+
  theme_bw()+
  theme(axis.text.x = element_text(angle=45, hjust=1, vjust=1),
        legend.position="none")
```

Le modèle exponentiel semble être soit aussi bon que le modèle linéaire soit meilleur. Il n'est moins bon qu'en de très rare occasions (p02 jusque T10)

```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, w=10, h=6, dpi=100}
# library(grid)
ggplot(mdR2, aes(x=Tlevel, y=value))+
  geom_point(size=4, aes(color=model)) +
  labs(title=("Évolution du R² des modèles linéaire (rouge) et exponentiel (bleu) \n liant la respiration de l'écosystème (Re) à la température (à différentes profondeur)"))+
#   annotate("segment", x=c(5,6), xend=(5,6), y=(0.4,0.4), yend=(0.6,0.6), color = "blue", size = 2, arrow=arrow())+
  facet_wrap(~model)+
  theme_bw()

# plt_name <- sprintf("/[pts][all][%s_%s].png",plt$labels$x, plt$labels$y)
# ggsave(paste(output_pth,plt_name,sep=""), width=12, height=8)

```


## Évolution de la moyenne de la respiration en fonction du nombre de placette : 
```{r , eval=TRUE, echo=FALSE, message=FALSE, warning=FALSE, w=10, h=6, dpi=100, cache=TRUE}
tirage <- 100
dat <- data.frame()
for (i in 2:20){# une série de tirage de 2 à 20 placette
  mn <- data.frame()
  for(h in 1:tirage){ # nb de tirage par taille
    sel <- as.vector(sample(unique(df$placette), i))
    w <- data.frame()
    for (j in sel){ # pour chaque item sélectionné on prend le sub7 qui correspond
      w <- rbind(w, df[which(df$placette == j),])
      }
    mn <- rbind(mn, mean(w$GPP, na.rm=T))
# round(exp(10*summary(lm(log(GPP)~Tmprt))$coef[2]), 2),
#     mn <- rbind(mn, exp(10*summary(lm(log(w$GPP)~w$Tair))$coef[2]))
    }
  if(i == 2){
    dat <- mn
    }else{
      dat <- cbind(dat,mn)
      }
  }
colnames(dat) <- 2:20

resul <- ddply(melt(dat), .(variable), summarise, mean=mean(value, na.rm=T),
               sd=sd(value, na.rm=T))

resul$se <- resul$sd/sqrt(tirage*as.numeric(as.character(resul$variable)))
resul$ci95 <- 95/2*resul$se

ggplot(resul, aes(x=variable, y=mean, group=1))+
#   geom_ribbon(aes(ymin=mean-se, ymax=mean+se), alpha = .2)+
  geom_line(aes(y=mean-se), colour="grey50", linetype = "dotted")+
  geom_line(aes(y=mean+se), colour="grey50", linetype = "dotted")+
#   labs(x="nombre de placette", y="moyenne Q10")+
  labs(x="nombre de placette", y="moyenne de la Respiration")+
  geom_line()+
  theme_bw()

ggplot(resul, aes(x=variable, y=mean, group=1))+
#   geom_ribbon(aes(ymin=mean-se, ymax=mean+se), alpha = .2)+
  geom_line(aes(y=mean-ci95), colour="grey50", linetype = "dotted")+
  geom_line(aes(y=mean+ci95), colour="grey50", linetype = "dotted")+
  geom_line()+
#   labs(x="nombre de placette", y="moyenne Q10")+
  labs(x="nombre de placette", y="moyenne de la Respiration")+
#   ylim(3,4)+
  theme_bw()
```
