---
title: "ER calibration (avg/campaign)"
author: "Benoît D'ANGELO"
date: "14 avril 2016"
output:
  html_document:
    code_folding: hide
    fig_height: 3
    fig_width: 7
    includes:
      in_header: ../../in_header.html
    theme: flatly
    toc: yes
    toc_depth: 2
    toc_float: true
---

<h3><a href="../mod_toc.html"> Calibration </a></h3>
***

# Objectives
This files describe the calibration of the ER fluxes. One file is generated:

* ER_mdlpar.csv (contains models parameters)

# Setup

## Load packages and set paths

```{r ld_pckg, message=FALSE}
# File name : /2013_spavar_LG/report/modelisation/calibration/ER_perCampaign.Rmd
rm(list=ls(all=TRUE)) # Clean start

# Homemade packages (see "Howto" page to install them)
library(bdphdtoolbox)     # personnal toolbox

# CRAN packages
library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(scales)

# Folder to save graphes
# savpth <- "/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/graphs/visualisation"

# Folder to save data treatement
outpth <- "/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/data/processed"

# allow wider tables and graphes in html output
options(width = 100)
knitr::opts_chunk$set(fig.width=12,fig.height=8)

# Load custom color set
source("../../../src/report/custom_colors.R")
# source("/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/src/report/custom_colors.R")
```

## Load functions

```{r ld_fn}
mdl_exp <- function(df, strt=list(a=0.1, b=0.3)){
mdl <- nls(Y ~ a * exp(b*X), data=df, start=strt, na.action = na.exclude)
}
mdl_lin <- function(df){
mdl <- nls(Y ~ a + b*X, data=df, start=list(a=0.1, b=0.3), na.action = na.exclude)
}
mdl_pwr <- function(df){
mdl <- nls(Y ~ a * X^b, data=df, start=list(a=0.1, b=0.3), na.action = na.exclude)
}
mdl_linexp <- function(df){
mdl <- nls(Y ~ (a*X2 + c) * exp(b*X), data=df, start=list(a=0.3, b=0.1, c=1), na.action = na.exclude)
}

mdl_linlinexp <- function(df){
mdl <- nls(Y ~ (a*X2 + c*X3) * exp(b*X), data=df, start=list(a=0.3, b=0.1, c=1), na.action = na.exclude)
}


pER_T <- function(df, x_lab){
par(mar=c(5.1,5.1,2.1,2.1))
plot(Y~X, xlab=x_lab, ylab=expression(paste("RE mesurée (", mu, mol,m^-2,s^-1,")", sep="")), data=df)
# curve(a*exp(b*x), add=T, col="blue")
}



mdl_param <- function(df, mdl){
  # R2
  devmean <- df$Y-(mean(df$Y)) # deviation à la moyenne
  SSres <-sum((resid(mdl))^2) # Total sum of squares
  SStot <- sum(devmean^2) # Residual sum of squares
  # 2 way to calculate
  # R2 <- (SStot-SSres)/SStot 
  R2 <- 1 - SSres/SStot
  # Adjusted R2
  N <- NROW(devmean) # sample size
  p <- 1 # number of predictors
  R2a <- 1-((1-R2)*(N-1))/(N-p-1)
  # RMSE
  rmse_mdl <- sqrt(mean(((predict(mdl))-df$Y)^2,na.rm=TRUE))
  nrmse_mdl <- 100*rmse_mdl/mean(df$Y)
  # Collect usefull param
  df <- data.frame(a=coef(mdl)[1],
                   b=coef(mdl)[2],
                   c=coef(mdl)[3],
                   a_se=coef(summary(mdl))[,"Std. Error"][1],
                   b_se=coef(summary(mdl))[,"Std. Error"][2],
                   c_se=coef(summary(mdl))[,"Std. Error"][3],
                   a_pval=coef(summary(mdl))[,"Pr(>|t|)"][1],
                   b_pval=coef(summary(mdl))[,"Pr(>|t|)"][2],
                   c_pval=coef(summary(mdl))[,"Pr(>|t|)"][3],
                   R2=R2,
                   aR2=R2a,
                   rmse=rmse_mdl,
                   nrmse=nrmse_mdl,
                   aic=AIC(mdl),
                   bic=BIC(mdl))
  return(df)
}

pmesmod <- function(df, mdl){
par(mar=c(4,4.5,.5,.5))
plot(Y~predict(mdl), 
     # ylim=c(0,200),xlim=c(0,200),
     xlab="", ylab="", data=df)
     # xlab=expression(paste("CH"[4]," modélisée (", mu, mol,m^-2,s^-1,")", sep="")),
     
     # ylab=expression(paste("CH"[4]," mesurée (", mu, mol,m^-2,s^-1,")", sep="")), data=df)
title(xlab=expression(paste("CH"[4]," modélisée (", mu, mol,m^-2,s^-1,")", sep="")), line=2.5)
title(ylab=expression(paste("CH"[4]," mesurée (", mu, mol,m^-2,s^-1,")", sep="")), line=2)
abline(a=0, b=1, col="black", lty=2)
text(.16,.17, "1:1", srt=45)
}

presmod <- function(mdl){
par(mar=c(4,4,.5,.5))
plot(resid(mdl)~predict(mdl), xlab="valeurs prédites", ylab="résidus")
}

```


## Load and transform data

```{r ld_data}
# Load treated data (generated with getClean_fluxesFC)
# Campaign average
dfm <- read.csv("/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/data/processed/cl_fluxesFC_avg.csv")%>%
  mutate(timestamp=as.POSIXct(as.character(timestamp)))%>%
  mutate(date=as.POSIXct(as.character(date)))
```

# Calculations
```{r mdl_calc}
# Tair mdl exp
dmdl_1 <- dfm %>%
  rename(Y=ER, X=Tair)%>%
  select(Y, X, WTL, RH_m, IVcov, A, H, M, NPOC)
mdl_1 <- mdl_exp(dmdl_1)
par_1 <- mdl_param(dmdl_1, mdl_1)
# Tair mdl pwr
dmdl_1b <- dfm %>%
  rename(Y=ER, X=Tair)%>%
  select(Y, X, WTL, RH_m, IVcov, H, NPOC)
mdl_1b <- mdl_pwr(dmdl_1b)
par_1b <- mdl_param(dmdl_1b, mdl_1b)
# T5 mdl exp
dmdl_2 <- dfm %>%
  rename(Y=ER, X=T5)%>%
  select(Y, X, WTL, RH_m, IVcov, H, NPOC)
mdl_2 <- mdl_exp(dmdl_2)
par_2 <- mdl_param(dmdl_2, mdl_2)
# Tair + IVcov mdl exp
dmdl_1_1 <- dfm %>%
  rename(Y=ER, X=Tair, X2=IVcov)%>%
  select(Y, X, X2, WTL, RH_m, H)
mdl_1_1 <- mdl_linexp(dmdl_1_1)
par_1_1 <- mdl_param(dmdl_1_1, mdl_1_1)
# Tair + H mdl exp
dmdl_1_2 <- dfm %>%
  rename(Y=ER, X=Tair, X2=H)%>%
  select(Y, X, X2, WTL, RH_m, IVcov, NPOC)
mdl_1_2 <- mdl_linexp(dmdl_1_2)
par_1_2 <- mdl_param(dmdl_1_2, mdl_1_2)
# Tair + RH mdl exp
dmdl_1_3 <- dfm %>%
  rename(Y=ER, X=Tair, X2=RH_m)%>%
  select(Y, X, X2, WTL, H, IVcov, NPOC)
mdl_1_3 <- mdl_linexp(dmdl_1_3)
par_1_3 <- mdl_param(dmdl_1_3, mdl_1_3)
# T5 + IVcov mdl exp
dmdl_2_1 <- dfm %>%
  rename(Y=ER, X=T5, X2=IVcov)%>%
  select(Y, X, X2, WTL, RH_m, H, NPOC)
mdl_2_1 <- mdl_linexp(dmdl_2_1)
par_2_1 <- mdl_param(dmdl_2_1, mdl_2_1)
# T5 + H mdl exp
dmdl_2_2 <- dfm %>%
  rename(Y=ER, X=T5, X2=H)%>%
  select(Y, X, X2, WTL, RH_m, IVcov, NPOC)
mdl_2_2 <- mdl_linexp(dmdl_2_2)
par_2_2 <- mdl_param(dmdl_2_2, mdl_2_2)
# T5 + RH mdl exp
dmdl_2_3 <- dfm %>%
  rename(Y=ER, X=T5, X2=RH_m)%>%
  select(Y, X, X2, WTL, H, IVcov, NPOC)
mdl_2_3 <- mdl_linexp(dmdl_2_3)
par_2_3 <- mdl_param(dmdl_2_3, mdl_2_3)
# T5 + IVcov + RH_m
dmdl_2_1_1 <- dfm %>%
  rename(Y=ER, X=T5, X2=IVcov, X3=RH_m)%>%
  select(Y, X, X2, X3, WTL, H, NPOC)
mdl_2_1_1 <- mdl_linlinexp(dmdl_2_1_1)
par_2_1_1 <- mdl_param(dmdl_2_1_1, mdl_2_1_1)
# T5 + H + RH_m
dmdl_2_2_1 <- dfm %>%
  rename(Y=ER, X=T5, X2=H, X3=RH_m)%>%
  select(Y, X, X2, X3, WTL, IVcov, NPOC)
mdl_2_2_1 <- mdl_linlinexp(dmdl_2_2_1)
par_2_2_1 <- mdl_param(dmdl_2_2_1, mdl_2_2_1)
```

```{r mdl_output}
# Resume

mdlls <- c("Tair", "Tair_pwr", "T5", "Tair_IVcov", "Tair_H","Tair_RH", "T5_IVcov", "T5_H", "T5_RH","T5_IVcov_RH", "T5_H_RH")

par <- c(par_1, par_1b, par_2, par_1_1, par_1_2, par_1_3, par_2_1, par_2_2, par_2_3, par_2_1_1, par_2_2_1)
mdlpar <- data.frame(matrix(unlist(par), nrow=length(mdlls), byrow=T))
colnames(mdlpar) <- c("a", "b", "c", "a_se", "b_se", "c_se", "a_pval", "b_pval", "c_pval", "R2", "R2a", "rmse", "nrmse", "aic", "bic")

res <- data.frame(mdl=mdlls)
res <- cbind(res, mdlpar)

not <- data.frame(best = c("<-","","","<-","<-","","","","<-","","" ))

best <- cbind(res, not)%>%
  filter(best == "<-")

result <- res
result[,-1] <- round(result[,-1],2) # round sauf 1re col
result <- cbind(result, not)
```

## Models

```{r}
result
```

## Models sort by R2a

```{r}
result %>%
  select(mdl, R2, R2a, rmse, nrmse, aic, bic, best)%>%
  arrange(desc(R2a))

result %>%
  select(mdl, a, b, c, a_se, b_se, c_se, a_pval, b_pval, c_pval)
```

# Diagnostic plots {.tabset}

## ER~aexp(bTair)

```{r, fig.height=4, eval=T}
par_1

par(mfrow=c(1,3))
pER_T(dmdl_1, "température de l'air cm (°C)")
curve(par_1$a*exp(par_1$b*x), add=T, col="blue")
pmesmod(dmdl_1, mdl_1)
presmod(mdl_1)
par(mfrow=c(1,1))
```
```{r, fig.height=7, eval=T}
par(mfrow=c(2,3))
plot(resid(mdl_1)~dmdl_1$WTL, main="vs. WTL") 
plot(resid(mdl_1)~dmdl_1$RH_m, main="vs. RH") 
plot(resid(mdl_1)~dmdl_1$IVcov, main="vs. IV cov")
plot(resid(mdl_1)~dmdl_1$A, main="vs. A")
plot(resid(mdl_1)~dmdl_1$H, main="vs. H")
plot(resid(mdl_1)~dmdl_1$M, main="vs. M")
plot(resid(mdl_1)~dmdl_1$NPOC, main="vs. NPOC")
par(mfrow=c(1,1))
```

## ER~aexp(bT5)

```{r, fig.height=4}
par_2
par(mfrow=c(1,3))
pER_T(dmdl_1, "température du sol à -5 cm (°C)")
curve(par_1$a*exp(par_1$b*x), add=T, col="blue")
pmesmod(dmdl_1, mdl_1)
presmod(mdl_1)
par(mfrow=c(1,1))
```
```{r, fig.height=3}
par(mfrow=c(1,4))
plot(resid(mdl_2)~dmdl_2$WTL, main="vs. WTL") 
plot(resid(mdl_2)~dmdl_2$RH_m, main="vs. RH") 
plot(resid(mdl_2)~dmdl_2$IVcov, main="vs. IV cov")
plot(resid(mdl_2)~dmdl_2$H, main="vs. H")
par(mfrow=c(1,1))
```

## ER~(a*IVcov + c) exp(bTair)

```{r, fig.height=4, eval=T}
par_1_1
par(mfrow=c(1,3))
pER_T(dmdl_1_1, "température de l'air cm (°C)")
# curve(par_1$a*exp(par_1$b*x), add=T, col="blue")
pmesmod(dmdl_1_1, mdl_1_1)
presmod(mdl_1_1)
par(mfrow=c(1,1))

par(mfrow=c(1,3))
plot(resid(mdl_1_1)~dmdl_1_1$WTL, main="vs. WTL") 
plot(resid(mdl_1_1)~dmdl_1_1$RH_m, main="vs. RH") 
plot(resid(mdl_1_1)~dmdl_1_1$H, main="vs. H")
par(mfrow=c(1,1))
```

## ER~(a*H + c) exp(bTair)

```{r, fig.height=4, eval=T}
par_1_2
par(mfrow=c(1,3))
pER_T(dmdl_1_2, "température de l'air cm (°C)")
# curve(par_1$a*exp(par_1$b*x), add=T, col="blue")
pmesmod(dmdl_1_2, mdl_1_2)
presmod(mdl_1_2)
par(mfrow=c(1,1))

par(mfrow=c(1,3))
plot(resid(mdl_1_2)~dmdl_1_2$WTL, main="vs. WTL") 
plot(resid(mdl_1_2)~dmdl_1_2$RH_m, main="vs. RH") 
plot(resid(mdl_1_2)~dmdl_1_2$IVcov, main="vs. IVcov")
plot(resid(mdl_1_2)~dmdl_1_2$NPOC, main="vs. NPOC")
par(mfrow=c(1,1))
```

## ER~(a*IVcov + c) exp(bT5)

```{r, fig.height=4}
par_2_1
par(mfrow=c(1,3))
pER_T(dmdl_2_1, "température du sol à -5 cm (°C)")
# curve(par_1$a*exp(par_1$b*x), add=T, col="blue")
pmesmod(dmdl_2_1, mdl_2_1)
presmod(mdl_2_1)
par(mfrow=c(1,1))

par(mfrow=c(1,3))
plot(resid(mdl_2_1)~dmdl_2_1$WTL, main="vs. WTL") 
plot(resid(mdl_2_1)~dmdl_2_1$RH_m, main="vs. RH") 
plot(resid(mdl_2_1)~dmdl_2_1$H, main="vs. H")
par(mfrow=c(1,1))
```

## ER~(a*RH + c) exp(bT5)

```{r, fig.height=4}
par_2_3
par(mfrow=c(1,3))
pER_T(dmdl_2_3, "température du sol à -5 cm (°C)")
# curve(par_1$a*exp(par_1$b*x), add=T, col="blue")
pmesmod(dmdl_2_3, mdl_2_3)
presmod(mdl_2_3)
par(mfrow=c(1,1))

par(mfrow=c(1,3))
plot(resid(mdl_2_3)~dmdl_2_3$WTL, main="vs. WTL") 
plot(resid(mdl_2_3)~dmdl_2_3$H, main="vs. H") 
plot(resid(mdl_2_3)~dmdl_2_3$IVcov, main="vs. IVcov")
par(mfrow=c(1,1))
```

# Figures

```{r, fig.height=8}
labpar_1 <- format(par_1,  digits=2, nsmall=2)
labpar_2 <- format(par_2,  digits=2, nsmall=2)
labpar_1_2 <- format(par_1_2,  digits=2, nsmall=2)
labpar_2_3 <- format(par_2_3,  digits=2, nsmall=2)


lab11 <- paste(
  "y = ", labpar_1$a, " * exp(", labpar_1$b, "*Tair)",
  "\nR² = ", labpar_1$aR2, 
  "\nRMSE = ", labpar_1$rmse, 
  "\nNRMSE = ", labpar_1$nrmse, " %", sep="")
lab21 <- paste0(
  "y = ", labpar_2$a, " * exp(", labpar_2$b, "*T5)",
  "\nR² = ", labpar_2$aR2, 
  "\nRMSE = ", labpar_2$rmse, 
  "\nNRMSE = ", labpar_2$nrmse, " %", sep="")


cairo_pdf(file.path("/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/graphs/carbonbalance/ecosyst/ER", "ER_T5_mdl_mesmod.pdf"), width=10, height=4)
par(mfrow=c(1,2), mar=c(4,4.5,.5,.5))
# pmesmod( ),
# par(mar=c(4,4.5,.5,.5))
plot(Y~predict(mdl_2), ylim=c(0,10), xlim=c(0,10), xlab="", ylab="", data=dmdl_2)
title(xlab=expression(paste("RE modélisée (", mu, mol,m^-2,s^-1,")", sep="")), line=2.5)
title(ylab=expression(paste("RE mesurée (", mu, mol,m^-2,s^-1,")", sep="")), line=2)
abline(a=0, b=1, col="black", lty=2)
text(19,20, "1:1", srt=45)

text(x=.1, y=8.6, labels=lab21, adj=0)
plot(resid(mdl_2)~predict(mdl_2), 
     xlab=expression(paste("Valeurs prédites (", mu, mol,m^-2,s^-1,")", sep="")),
     ylab=expression(paste("Résidus (", mu, mol,m^-2,s^-1,")", sep=""))) 
par(mfrow=c(1,1))

cairo_pdf(file.path("/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/graphs/carbonbalance/ecosyst/ER", "ER_T5_mdl_res.pdf"), width=5, height=4)
par(mfrow=c(1,1), mar=c(4,4.5,.5,.5))
# plot(resid(mdl_2)~dmdl_1$WTL, main="vs. WTL") 
# plot(resid(mdl_2)~dmdl_1$RH, main="vs. RH") 
plot(resid(mdl_2)~dmdl_1$IVcov, 
     xlab="indice de végétation",
     ylab=expression(paste("Résidus (", mu, mol,m^-2,s^-1,")", sep=""))) 
par(mfrow=c(1,1))

## Figure Tair T5

cairo_pdf(file.path("/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/graphs/carbonbalance/ecosyst/ER", "ER_mdl.pdf"), width=9, height=8)
par(mfrow=c(2,2), mar=c(4,4.5,.5,.5))

# Haut 
pmesmod(dmdl_1, mdl_1)
text(x=.1, y=8.6, labels=lab11, adj=0)
text(x=9, y=1, labels="a", adj=0, cex=2)

plot(resid(mdl_1)~predict(mdl_1), 
     xlab="", ylab="") 
title(xlab=expression(paste("Valeurs prédites (", mu, mol,m^-2,s^-1,")", sep="")), line=2.5)
title(ylab=expression(paste("Résidus (", mu, mol,m^-2,s^-1,")", sep="")), line=2)
text(x=9, y=-1, labels="b", adj=0, cex=2)

# Bas
pmesmod(dmdl_2, mdl_2)
text(x=.1, y=8.6, labels=lab21, adj=0)
text(x=9, y=1, labels="c", adj=0, cex=2)

plot(resid(mdl_2)~predict(mdl_2), 
     xlab="", ylab="", 
     xlim=c(1,10)) 
title(xlab=expression(paste("Valeurs prédites (", mu, mol,m^-2,s^-1,")", sep="")), line=2.5)
title(ylab=expression(paste("Résidus (", mu, mol,m^-2,s^-1,")", sep="")), line=2)
text(x=9, y=-1.6, labels="d", adj=0, cex=2)

par(mfrow=c(1,1))

# cairo_pdf(file.path("/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/graphs/carbonbalance", "ER_1par_mdl_res.pdf"), width=10, height=8)
# par(mfrow=c(2,2))
# pmesmod(dmdl_1, mdl_1)
# text(x=1, y=8, labels=lab11, adj=0)
# pmesmod(dmdl_2, mdl_2)
# text(x=1, y=8, labels=lab21, adj=0)
# plot(resid(mdl_2)~dmdl_1$RH_m, main="vs. TES") 
# par(mfrow=c(1,1))
# 
# lab11 <- paste(
#   "y = (", labpar_1_2$a, " * H + ", labpar_1_2$c, ") * exp(", labpar_1_2$b, "*Tair)",
#   "\nR² = ", labpar_1_2$aR2, 
#   "\nNRMSE = ", labpar_1_2$nrmse, sep="")
# lab21 <- paste0(
#   "y = (", labpar_2_3$a, " * TES + ", labpar_2_3$c, ") * exp(", labpar_2_3$b, "*T5)",
#   "\nR² = ", labpar_2_3$aR2, 
#   "\nNRMSE = ", labpar_2_3$nrmse)
# 
# cairo_pdf(file.path("/home/dangelo/Documents/4.ScienceStuff/2.Projects/2013_spaVar_LG/graphs/carbonbalance", "ER_2par_mdl.pdf"), width=10, height=4)
# par(mfrow=c(1,2))
# pmesmod(dmdl_1_2, mdl_1_2)
# text(x=1, y=8, labels=lab11, adj=0)
# # plot(resid(mdl_1)~dmdl_1$H, main="vs. H") 
# pmesmod(dmdl_2_3, mdl_2_3)
# text(x=1, y=8, labels=lab21, adj=0)
# # plot(resid(mdl_2)~dmdl_1$RH_m, main="vs. TES") 
# par(mfrow=c(1,1))
```

# Data
```{r sav_mdl_par}
select(best, -best)

export <- res %>%
  select(mdl, a, b, c)

filepath_mdl <- paste0(outpth, "/ER_mdlpar.csv")
write.csv(export, filepath_mdl, quote=F, row.names=F)
```
